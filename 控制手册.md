# RTS控制组手册

本手册借鉴于RTS战队控制手册第2版，感谢制作者赵小铭、刘力、肖君、刘有用、田雨丰与修订者苏超明。

## 电控系统结构

### 整体架构

2023年比赛控制体系并不清晰，在比赛前半个月进行了hal库重构，分任务块并行多个结构执行，在比赛结束后的反思与学习中，应该采用分布式控制逻辑，将核心主控与各模块进行分离，推荐架构如下图

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-08-13-循环结构流程图.png)

通过定位反馈与闭环实现路径自动化，通过视觉确定目标位置调节上层机构，实现功能自动化，手柄需要考虑抗干扰，2023年北航由于wifi断联两车高速相撞起火，错失一等奖。

### STM32架构

就控制方向来说，咨询传统强队来看控制逻辑都相对比较简单，算法比较传统，但是需要做到极致就可以得到极好的控制效果，电科在2023年的底盘运动规划运用单一PID实现了超乎想象的速度与精准度，但是不能固步自封，需要在合适的时间与时俱进，更新算法与架构。

在这种背景下，对STM32的要求没有特别高，运用cubemx+hal+FreeRTOS能够极大的减少工作量，提升工作效率，在我们需要追求极致后可以考虑将部分程序移植至标准库等提升效率。

## 控制与其他组进行结合

### 视觉

视觉与控制的交叉工作较多，日常交流较多，总体不存在交流阻塞问题，但是需要明确接口协议与通信延迟问题，避免由于帧数和帧对齐问题出现无法控制问题。

### 机械

机械交流问题一定要重视，RTS自2015年起就面临这个问题，换届多次问题一直没有得到十分妥善的结局，理念总结如下：

2015年：机器人是一个复杂的系统，涉及到机械结构、电机控制、图像识别、上层决策等多方面的知识。严格来讲，我们机器人队所制作的机器人并不能称之为机器人；平常我们都称之为“车”。总体来讲，我们的机器人包含了总体方案的确定，机械结构的设计、加工，控制程序的编写、调试。ROBOCON2015北交机器人队存在一个比较严重的问题，那就是机械组和控制组交流比较少，导致最后的结果是机械组设计出机械结构出来，然后让控制组去想办法控制，而不是机械组和控制组一起商量怎么制作这个机器人，全部是按照机械组的想法去设计，最后有一些控制的东西都没法安装到机器人上。我跟电科交流了解到，他们主要是机械组在做主导，所有的东西基本都是机械组在做，机械组能做的东西决不让控制组来做，这样看来，他们的机械组掌握的技术还是比较全面的，这样设计的东西可以更好的与控制部分结束。中石油则不是，他们的培训分为3个阶段，其中第一个阶段是智能小车的制作，这个阶段是控制组和机械组都必须参加的，这样来说，机械组对控制部分也就有了一个总体的了解，也就建立起了系统的概念。另一方面，增进控制组和机械组的交流还可以组织一些活动来增进队员之间的相互了解。比如说，素质拓展，跑男中的撕铭牌等等。以上只是一些个人的见解，仅供参考。

2020补充：交流问题没有得到太好的改善，控制需要主动提出意见，让机械去实现。还有就是控制和机械组员的交流。

2023补充：交流问题仍然存在，推荐采用广播机制，固定以周或者半月为期限，固定将任务系统的公布到大群中，实现不仅仅组长交流，全队都要有了解。

### 电路

电路作为2023比赛结束后成立的新组，处于探索阶段，现在只有2015年的经验可以借鉴，如下：

#### PCB设计

##### 需求分析

进行任何项目前首先得进行需求分析，了解需要哪些功能，需要多大的功率，稳定性的考虑，还可能有哪些扩展的功能。

下面我以ROBOCON2015所做的来分析。

1.     要控制底盘运动，需要给4个运动控制器发送控制指令。给控制器发送指令的方式多种多样，由于我们开发出来了CAN总线控制方式，因此，首先我们需要一个CAN总线接口来控制底盘的运动。

2.     我们需要得到机器人在场地上面的坐标位置，通常来讲，这个是由码盘和陀螺仪完成的。码盘使用的是正交编码方式输出数据，陀螺仪使用的是串口输出数据，因此，我们需要预留正交编码接口和RS232电平的串口。

3.     每年机器人比赛必不可少的东西-------气缸，使用继电器控制，因此，必须预留继电器接口。

4.     今年要求使用的无线通信为蓝牙，我们使用的蓝牙模块以串口(TTL)方式输出，则必须预留TTL电平串口接口。

5.     考虑到有一个机器人可以使用有线方式进行操作控制，因此我们应该预留有线手柄接口。参照我们目前使用的PS手柄的协议，预留一个SPI 接口。

6.     考虑到上层视觉和轨迹拟合实现的可能性，我们需要预留和工控机通信的接口，因此我们预留一个TTL电平的串口和上位机进行通信。

7.     使用自动方式时，使用气缸接球变得不那么合适，首先是气缸随着使用次数的增加会走气，不能稳定的发挥；其次是气缸冲击比较大，会导致比较大的震动，不利于系统的稳定运行。因此使用电机带动球拍去接球，需要预留CAN接口和电机的码盘接口。

8.     系统的运行必须得有指示，因此，预留了几个LED指示灯，预留了一个OLED显示屏接口，同时预留了几个按键接口。

2020补充：有线手柄控制预留SPI的接口，无线通信预留一个串口以及供电接地还有模式选择接口（高低电平控制），与手柄直接通信才需要SPI

##### 元件选型

元件的选型非常重要，进行元件选型时，要考虑以下几个方面的因素：

1．电源电压是否满足要求。(常见的有5V供电的和3.3V供电)

2．元件输出电平是否满足要求。(TTL电平、CMOS电平、RS232电平等)

3．元件的输出功率和输入功率。(STM32引脚高电平输出时不能直接驱动大电流负载，因为输出功率不够)

4．防干扰的考虑。(使用继电器必须添加光耦隔离，否则继电器动作时产生的干扰信号足以影响单片机的正常工作；其他外围模块尽量添加隔离，如CAN、RS232芯片)

5．元件稳定性的考虑。(购买元件时尽量使用贵的、非国产的元件，这些元件质量有保证，不会经常出现芯片被烧毁、不能正常工作的情况)

6．外围模块的参数选择。(购买外围模块一定要仔细核对关键参数，尽量使用好评多、成交量大、使用广泛可靠的模块。也要用于尝试新的模块，开发新的功能)

##### 电路设计

电路涉及了数电、模电、单片机的知识。从元件来讲，分为运放相关电路，三极管相关电路，MOS相关电路、单片机相关电路。从功能来讲，分为电源部分电路，单片机最小系统电路，外围模块驱动电路，模拟放大电路等等。要做电路设计必须对以上提到的各个电路有一定的了解，具体需要设计的时候有一个大体的思路，然后在温习相关知识进行具体细节的设计。

###### 电源电路

电源稳定输出是一个电子系统正常运行的最基本要求。

1.电池

A）锂电池的一些主要标称指标专用名词的含义

标称电压：锂聚合物电池的单体标称电压为3.7V。

充电后电压：锂聚合物电池充足电之后的单体电压为4.2V。

　　标称容量：单位mAh，表明了电池的蓄电量。

　　持续放电倍数：单位C，表明了电池的最大持续放电电流。

　　瞬间放电倍数：单位C，表明了电池的在极短的时间内(10s内)的最大放电电流，此指标不具有普遍的使用指导。

B） 计算电池组规格的方法

1. 确定使用电压，电池充电后电压(一般按照每节电芯4V)用电器最大工作电压，可以通过多块电池串联(最终电压=单体充电后电压x电池数)获得需要的更高电压的电池组。

2. 确定最大工作电流，用电器最大工作电流 < 电池标称容量x持续放电倍数，如果持续放电倍数已经确定，那么可以通过多块电池并联【一般不并联】(最终标称容量=单体标称容量x电池数)获得需要的更高容量的电池组。

(注：并联或者串联的电池必须保证标称容量完全一致，使用完全相同的电芯)。

C）电池的正确使用

1. 从保护电池的角度出发，新的电池我们可以在正式使用之前进行激活，激活就是多次冲放电过程，比如3-5次，每次充包后在用电器上放电不超过容量的70%，这个过程可以使电池的使用电压更稳定！其实，电池在出厂之前已经做过了激活，而且是在专业的充放电柜中完成的，那么我们自己的激活主要是可以较早的发现电池可能存在的质量问题！

　　2. 激活以后我们就可以正常使用了，在使用中注意，用电器的最大电流不能大于电池的最大持续放电电流；应该使用具有低电压保护的功能调速器(锂聚合物电池单体电压不能低于3V)；使用环境的最高温度不高于50-60摄氏度；对于大电流工作的电池必须保持电池的通风降温。

　　3. 如果在使用中出现，电池鼓胀，破裂，漏液等情况，必须立即停止使用！如果在充电过程中出现上述现象同样立即停止充电！

　　4. 锂电池的充电过程有非常严格的要求，为了保护正常的电池不出现任何的异常，必须保证使用锂电池专用的充电器来为电池充电。任何形式的锂电池专用的充电器都具有充包电后自动的停止充电的功能，因为如果对已经充包的电池继续充电将出现，电池鼓胀，破裂，漏液，甚至燃烧或者爆炸！

D） 电池的保存

如果你的锂聚合物电池需要长时间的停用，比如1个月，6个月，甚至更长时间！那么合理的处理方式将保证你的电池不会在储存中损坏。

　　注意做到以下几点：

　　1. 储存的温度不要高于20-25摄氏度。

　　2. 储存之前对电池进行最后一次充电，检查每一片电池的电压，保证电池组中的电池电压都基本一致(误差+/-0.01V)，然后进行放电，随后保存。

3. 如果长于1个月的停用，那么每个月定期检查一次每一片电池的电压，保证其中最低的电池电压不低于3.5V，如果低于3V则再进行第2点的充放电过程。

E）  电池的制作

1. 航模电池及充电器购买

3.7v的电芯，25C，C是指放电倍率，容量4000mah左右。放电倍率乘容量即为放电电流。可以充电到4.2V，电显设置为3.7V报警就可以；现用充电器是IMAX B6平衡充电器，带并充板，1-8S电显，4200mah,6S（S是串的意思）狮子牌航模电池。

航模电池制作

放置电芯时要并联放置，防止短路发生危险。每片电芯正负极为镍片，可以打磨方便上焊锡处理。KT板（展板）剪小条放在两极板之间，电源线用比较粗的。接头用T插，买充电的白色接头和配套端子，方便充电。泡沫胶粘在电心上下两边，防震，保护电池。热缩管直径50mm以上（50mm用在套柱状锂电池合适）套在电池上。制作电池时一定要小心谨慎，不得短路，焊接时要焊牢。用耐高温隔热胶带把两极端子包好。

F）  电池充电

25.2V航模电池：

电池插在充电板上（两个口均插）；

充电模式为平衡充(Balance)模式，如果没有显示Balance则按Inc按钮至显示Balance；

注：充电器的输出串数(显示为”n”s)和电池的串数必须相同，否则不能进行充电；可利用按钮dec和inc设置充电节数，按钮enter确定。

3. 设置完成后长按start后再次按start确认，即开始充电；

4. 充电过程可按Inc查看每节电池电量；

5. 充电120分钟(显示TIME)或充满电(显示FULL)均会报警，如果没充到25.2V则再次充电（注：取下电池前先按按钮stop，否则拔插时会出现电火花）。

其他电池：

一定要使用电压和电流匹配的充电器进行充电。

2. 稳压电源

根据调整管的工作状态，我们常把稳压电源分成两类：线性稳压电源和开关稳压电源。线性稳压电源是比较早使用的一类直流稳压电源。两种电源各有优劣，具体应该是用哪一种稳压电源给电子系统供电，取决于系统的要求。线性稳压电源的特点是输出纹波小、输出电压比输入电压低、反应速度快、输出纹波较小、工作产生的噪声低，但是其效率较低、发热量大，其转换效率通常不超过40%。开关型稳压电源的特点是输出效率较高、体积小、重量轻、稳压范围宽，但是由于开关电源内部的开关作用，其输出的电压通常会带有等于其开关频率的毛刺，不适合在模拟电子系统中使用。由上所述，线性电源通常使用在模拟电路和对纹波要求较小的AD采集电路中，而开关电源更适合用在对电源噪声不敏感的数字电路中。

线性稳压直流电源的特点是：

输出电压比输入电压低；反应速度快，输出纹波较小；工作产生的噪声低；

效率较低（现在经常看的LDO就是为了解决效率问题而出现的）；发热量大（尤其是大功率电源），间接地给系统增加热噪声。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-30-19-image.png)

常用的线性串联型稳压电源芯片有：78XX系列（正电压型），79XX系列（负电压型）（实际产品中，XX用数字表示，XX是多少，输出电压就是多少。例如7805，输出电压为5V）；LM317（可调正电压型），LM337（可调负电压型）；1117（低压差型，有多种型号，用尾数表示电压值。如1117-3.3为3.3V，1117-ADJ为可调型）。

开关型稳压电源

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-30-26-image.png)

常见开关稳压电源有：可调升压开关稳压器LM2577，3A降压开关稳压器LM2596，高效率5A开关稳压器LM2678 等等。

我们今年使用了LM2596作为主要的电源芯片，电路如下：

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-30-34-image.png)

此外，还使用了AMS1117作为稳压芯片：

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-30-40-image.png)

         这两种稳压电路比较常见，但实际制作电路的过程中也容易出现一些问题，在邹城比赛交流的时候，了解到其他学校大多直接使用了DC-DC模块进行稳压处理，这样就节省了电源电路制作的时间开销。同时，由于许多DC-DC模块还含有完善的保护电路，因此可以比较稳定的使用。建议以后直接使用DC-DC模块，从而集中时间和精力区开发高层算法。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-30-49-image.png)

b)单片机最小系统

要使单片机正常运行，必须搭建单片机的最小系统。单片机最小系统主要包含时钟电路，这一部分一般使用无源晶振来提供稳定的系统时钟。我们今年尝试使用了3225贴片封装的无源晶振，但是出现了时钟不稳定导致单片机不能工作的情况，来年有望研究下具体原因和尝试使用下有源晶振。单片机最小系统还包括系统复位电路、电源滤波电路和程序下载口。Robocon2015中使用的最小系统如下图所示：

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-31-05-image.png)

c) 单片机外围模块驱动

Robcon2015中使用的外围模块主要包括编码器、蓝牙模块、继电器、CAN总线、OLED、TTL串口和RS232串口。

编码器分为增量式编码器和绝对式编码器，具体原理与输出方式请查阅相关资料。我们使用的编码器12V供电，输出AB相正交编码信号，是增量式编码器。需要提供12V电压。此外，陀螺仪也是12V供电。

继电器是一种弱电控制强电的模块，我们的气缸使用的电磁阀需要比较大的电流和电压来控制，STM32输出引脚不能输出如此大的电流和电压，因此必须使用继电器。此外，继电器必须使用光电隔离，不然的话会导致单片机复位甚至不能正常工作，这是由于继电器工作时比较大的脉冲干扰导致的。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-31-25-image.png)

CAN总线使用的差分电压表示数字信号，使用差分信号的好处是可以有效的避免干扰。我们去年使用了TI的SN65HVD230和SN65HVD1050，前者是3.3V供电版本，后者是5V供电版本，由于运动控制器CAN信号是5V压差版，我们前期使用3.3V版时出现一些不稳定现象，因此后期换用了5V版本。此外，在与北科交流的过程中，有了解到他们所有的芯片都是带有电气隔离的，因此今后可以尝试使用带隔离的CAN模块。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-31-31-image.png)

陀螺仪是12V供电，通信采用RS232电平，因此我们必须使用串口电平转换芯片，我们选用了使用较为广泛的MAX232。MAX232可以提供两路的串口电平转换，因，除了陀螺仪的通信接口之外，我们还预留了一个多余的RS232接口。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-31-47-image.png)

其余模块均使用TTL电平，并且需要的驱动要求不高，因此，我们直接将其和单片机引脚相连，并不需要外围模块电路。

d)  运动控制电路

Robocon2015中，我们直接使用了Accelnet运动控制器，此控制器可以通过串口、CAN、正交编码、PWM等多种方式进行控制，并且内置保护电路。我们Robocon2015使用了CAN总线来控制。

此外，参考Robomasters比赛的电机驱动如下图：

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-31-55-image.png)

3)布局与布线

布局与布线的技巧需要在实际画板子中不断的领会与学习，其中有一些我自己领会的技巧在这里总结如下。仅仅抛砖引玉，如有描述不尽之处，还请海涵。

a)布局

心中首先得有一个大体的规划，即哪一块为电源，哪一块放置芯片，哪些地方放置接口等等。

一般来讲，电源接口和稳压电路放置在同一区域。需要考虑安装方式，板子电压区域划分，电流走向等等。一般将主控芯片放置在板子的中央，然后又芯片引出各个外围模块的连线。一般将接口放置在板子的外围，这里必须注意接口的安装方向，平卧的接口不能将接口冲板子内部放置，这样就没发连接了。

板子布局时，可以使用Altium Designer的交互布线布局功能和联合功能，具体使用方法自行百度或咨询学长。布局时要考虑连线的方向。在布线时，可以看到很多灰色的细线连接在一起，这就是带连接的线路，布局时首先要考虑最密集的连线区域，此外还要尽量减少交叉的连接。

电容的作用：在画电源电路和最小系统是往往可以看到很多电容并联在一起，其中常见的值有100nF，1uF等。在电源电路中，输入端连接两个电容，一个100nF小电容，用来吸收高频毛刺，一个1uF~10uF的大电容，用来稳定电压的输入，提供一个补偿的作用；输出端两个电容是同样的功能。在单片机最小系统中，晶振两端旁路到地的两个电容(常见值范围10pF~30pF)是用来给晶振提供起振工作条件的，不能过大或者过小，具体值请参考相应单片机的datasheet。另外单片机最小系统中一系列的100nF并联电容是用来进行电源滤波的，最好靠近在单片机每一个电源输入引脚并联一个。

b)布线

首先连接最密集的信号线，连接基本的信号线；然后连接电源线；最后补泪滴和覆铜。

布线时尽量让顶层线和底层线相互交叉，这样可以减少不能走线的情况发生。电源线要尽量粗，考虑到电流大小，使之不至于烧毁。此外，并不是说画好电路后开始画PCB板时就不能改电路了。比如说，在布线的时候发现两个连接改一下单片机的引脚连接顺序可以更简单的布线，而改变引脚顺序又不影响最终的功能时，可以进入原理图将两个连接更改顺序，然后Uptade到PCB再布线。

### PCB制板

PCB板绘制好之后，就要送至工厂制板。送去工厂的文件格式有两种，我们使用Altium Designer系列PCB绘制软件可以发送PCBdoc文件，也可以发送Gerber文件。其中PCBdoc文件是Altium Designer系列的PCB文件，其中包含了PCB板图和网表信息，为了防止别人窃取原理图，可以发送Gerber文件给PCB制板厂商。其中Gerber格式是线路板行业软件描述线路板（线路层、阻焊层、字符层等）图像及钻、铣数据的文档格式集合，它是线路板行业图像转换的标准格式。

国内常见的PCB制板厂商大都在深圳，其中有嘉立创、华强PCB等多家厂商，可以在淘宝或者他们官网联系他们下单制板。制板的价格一般按照制板的工艺(板厚、铜厚、油墨颜色、板子层数等)、板子的大小而定。

2020补充：如果需要打的板子不大，可以拼版。操作一：新建一个PCB文件，确定大板子的大小，然后复制要拼版的板子，E-A选择第三个，然后调整参数即可，然后要在机械层画出分割线（V-CUT）

### PCB焊接

PCB焊接是一个技术活。

如果待焊接的元件是直插型的元件，只需要将元件插入对应的焊盘内，然后用电烙铁预热2~3秒，在将焊锡丝送入焊接点，使焊锡均匀分布即可。注意，一定要让焊锡将焊盘和元件连接牢固稳定，不能出现虚焊漏焊。

如果待焊接的元件是贴片元件，就要非常注意了。我们使用的贴片电容电阻大都是0805封装，越小的封装焊接难度越大，0805的封装基本是我们可以手工焊接的极限了。

焊接0805贴片电阻和电容的技巧是用左手拿镊子夹住待焊接的元件，用右手拿电烙铁(先在电烙铁上点一些焊锡)，将元件放到合适位置后将元件的一个引脚焊上，等待2~3秒，松开镊子，就焊好了一个引脚。用同样的方式焊接其他0805封装元件的一个引脚，然后再统一焊接另一个引脚。注意，此方式流水作业比较快，但一定不能漏焊虚焊。

焊接SMT32这种PLCC封装的元件时，一定要保证板子和烙铁的干净整洁，烙铁上的焊锡一定要先搽洗干净，不能有多余的焊锡，否则容易使引脚短路。首先将元件仔细调整到板子上，检查元件的4个方向引脚是否对准无误，检查对准后固定对角的两个引脚，让芯片固定在板子上，然后使用烙铁将助焊剂均匀涂抹在一侧引脚上，再使用焊锡丝在烙铁头点一些焊锡(注意用量，过多会导致引脚短路)，将烙铁头在引脚上来回涂抹即可(这就是所谓的拖焊)。

### PCB设计规范

PCB设计时要考虑多种因素，这里将设计规则整理如下(这是生产工艺的要求)：

(1)    字符字宽不能小于0.153mm(6mil),字高不能小于0.811mm(32mil), 宽度比高度比例最好为5的关系 也为就是说，字宽0.2mm 字高为1mm。

(2)    孔径问题：方形插接件上面，最常见的问题就是0.6mm的插针，以为只有0.6mm的直径，孔径按照0.8mm已经足够，实际上，方形的元件脚，需要按照对角来测量尺寸的，所以实际有0.84mm以上，这样我们在设计的时候一定要大于或者等于0.85mm，切记！

(3)    安装孔问题：实际中我们一般使用铜柱或者尼龙柱作为固定柱子，因此安装孔统一为3mm直径，但在画板子的时候需要留出一定余量，一方面是生产可能有误差，另一方面方便安装，一般设计为3.2mm~3.4mm即可。

(4)    Keepout层：一般生产厂商将keepout layer作为切割的依据，也就是说keepout
layer画的线都将割开。

(5)    走线极限参数：最小线宽：6mil，最小间距：6mil，最小阻焊桥宽：0.1mm。

## 控制积累的算法

#### 卡尔曼滤波

简单来说，卡尔曼滤波器是一个“optimal recursive data processing algorithm（最优化自回归数据处理算法）”。对于解决很大部分的问题，他是最优，效率最高甚至是最有用的。他的广泛应用已经超过30年，包括机器人导航，控制，传感器数据融合甚至在军事方面的雷达系统以及导弹追踪等等。近来更被应用于计算机图像处理，例如头脸识别，图像分割，图像边缘检测等等。

卡尔曼滤波器的介绍

为了可以更加容易的理解卡尔曼滤波器，这里会应用形象的描述方法来讲解，而不是像大多数参考书那样罗列一大堆的数学公式和数学符号。但是，他的5条[公式](http://baike.baidu.com/view/645857.htm)是其核心内容。结合现代的计算机，其实卡尔曼的程序相当的简单，只要你理解了他的那5条[公式](http://baike.baidu.com/view/645857.htm)。

在介绍他的5条公式之前，先让我们来根据下面的例子一步一步的探索。

假设我们要研究的对象是一个房间的温度。根据你的经验判断，这个房间的温度是恒定的，也就是下一分钟的温度等于现在这一分钟的温度（假设我们用一分钟来做时间单位）。假设你对你的经验不是100%的相信，可能会有上下偏差几度。我们把这些偏差看成是高斯白噪声（White Gaussian Noise），也就是这些偏差跟前后时间是没有关系的而且符合高斯分布（Gaussian Distribution）。另外，我们在房间里放一个温度计，但是这个温度计也不准确的，测量值会比实际值偏差。我们也把这些偏差看成是高斯白噪声。

好了，现在对于某一分钟我们有两个有关于该房间的温度值：你根据经验的预测值（系统的预测值）和温度计的值（测量值）。下面我们要用这两个值结合他们各自的噪声来估算出房间的实际温度值。

假如我们要估算k时刻的实际温度值。首先你要根据k-1时刻的温度值，来预测k时刻的温度。因为你相信温度是恒定的，所以你会得到k时刻的温度预测值是跟k-1时刻一样的，假设是23度，同时该值的高斯噪声的偏差是5度（5是这样得到的：如果k-1时刻估算出的最优温度值的偏差是3，你对自己预测的[不确定度](http://baike.baidu.com/view/84767.htm)是4度，他们平方相加再开方，就是5）。然后，你从温度计那里得到了k时刻的温度值，假设是25度，同时该值的偏差是4度。

由于我们用于估算k时刻的实际温度有两个温度值，分别是23度和25度。究竟实际温度是多少呢？相信自己还是相信温度计呢？究竟相信谁多一点，我们可以用他们的协方差(covariance)来判断。因为Kg=5^2/(5^2+4^2)，所以Kg=0.61，我们可以估算出k时刻的实际温度值是：23+0.61*(25-23)=24.22度。可以看出，因为温度计的协方差(covariance)比较小（比较相信温度计），所以估算出的最优温度值偏向温度计的值。

现在我们已经得到k时刻的最优温度值了，下一步就是要进入k+1时刻，进行新的最优估算。到现在为止，好像还没看到什么自回归的东西出现。对了，在进入k+1时刻之前，我们还要算出k时刻那个最优值（24.22度）的偏差。算法如下：((1-Kg)*5^2)^0.5=3.12。这里的5就是上面的k时刻你预测的那个23度温度值的偏差，得出的3.12就是进入k+1时刻以后k时刻估算出的最优温度值的偏差（对应于上面的3）。

就是这样，卡尔曼滤波器就不断的把(协方差(covariance)递归，从而估算出最优的温度值。他运行的很快，而且它只保留了上一时刻的协方差(covariance)。上面的Kg，就是卡尔曼增益（Kalman Gain）。他可以随不同的时刻而改变他自己的值，是不是很神奇！

下面就要言归正传，讨论真正工程系统上的卡尔曼。

卡尔曼滤波器算法 ：

在这一部分，我们就来描述源于Dr Kalman 的卡尔曼滤波器。下面的描述，会涉及一些基本的概念知识，包括概率（Probability），随机变量（Random Variable），高斯或正态分配（Gaussian Distribution）还有State-space Model等等。但对于[卡尔曼滤波器](http://baike.baidu.com/view/2943745.htm)的详细证明，这里不能一一描述。

首先，我们先要引入一个离散控制过程的系统。该系统可用一个线性随机微分方程（Linear Stochastic Difference equation）来描述：

X(k)=A X(k-1)+B U(k)+W(k)

再加上系统的测量值：

Z(k)=H X(k)+V(k)

上两式子中，X(k)是k时刻的系统状态，U(k)是k时刻对系统的控制量。A和B是系统参数，对于多模型系统，他们为矩阵。Z(k)是k时刻的测量值，H是测量系统的参数，对于多测量系统，H为矩阵。W(k)和V(k)分别表示过程和测量的噪声。他们被假设成高斯白噪声(White Gaussian Noise)，他们的协方差(covariance)分别是Q，R（这里我们假设他们不随系统状态变化而变化）。

对于满足上面的条件(线性随机微分系统，过程和测量都是高斯白噪声)，卡尔曼滤波器是最优的信息处理器。下面我们结合他们的协方差来估算系统的最优化输出（类似上一节那个温度的例子）。

首先我们要利用系统的过程模型，来预测下一状态的系统。假设现在的系统状态是k，根据系统的模型，可以基于系统的上一状态而预测出现在状态：

X(k|k-1)=A X(k-1|k-1)+B U(k) ……….. (1)

式(1)中，X(k|k-1)是利用上一状态预测的结果，X(k-1|k-1)是上一状态最优的结果，U(k)为现在状态的控制量，如果没有控制量，它可以为0。

到现在为止，我们的系统结果已经更新了，可是，对应于X(k|k-1)的协方差还没更新。我们用P表示协方差(covariance)：

P(k|k-1)=A P(k-1|k-1) A’+Q ……… (2)

式(2)中，P(k|k-1)是X(k|k-1)对应的协方差，P(k-1|k-1)是X(k-1|k-1)对应的协方差，A’表示A的转置矩阵，Q是系统过程的协方差。式子1，2就是[卡尔曼滤波器](http://baike.baidu.com/view/2943745.htm)5个公式当中的前两个，也就是对系统的预测。

现在我们有了现在状态的预测结果，然后我们再收集现在状态的测量值。结合预测值和测量值，我们可以得到现在状态(k)的最优化估算值X(k|k)：

X(k|k)= X(k|k-1)+Kg(k) (Z(k)-H X(k|k-1)) ……… (3)

其中Kg为卡尔曼增益(Kalman Gain)：

Kg(k)= P(k|k-1) H’ / (H P(k|k-1) H’ + R) ……… (4)

到现在为止，我们已经得到了k状态下最优的估算值X(k|k)。但是为了要令卡尔曼滤波器不断的运行下去直到系统过程结束，我们还要更新k状态下X(k|k)的协方差：

P(k|k)=（I-Kg(k) H）P(k|k-1) ……… (5)

其中I 为1的矩阵，对于单模型单测量，I=1。当系统进入k+1状态时，P(k|k)就是式子(2)的P(k-1|k-1)。这样，[算法](http://baike.baidu.com/view/7420.htm)就可以自回归的运算下去。

卡尔曼滤波器的原理基本描述了，式子1，2，3，4和5就是他的5 个基本公式。根据这5个公式，可以很容易用计算机编程实现。

### 路径规划算法

## 编程规范

要求使用vscode+iar+cubemx，iar只用来编译和烧录，不得用于修改后保存，vscode安装doxygen插件，cubemx保持最新版，iar目前保持8.32.1，可以根据时机进行更新

### 注释规范

运用doxgen标准注释，运用[Doxygen: Doxygen](https://www.doxygen.nl/index.html)进行文档生成，配置文件见附件。

### 代码规范

#### 变量名

#### 函数名

#### 文件名

## STM32基本知识

STM32系列基于专为要求高性能、低成本、低功耗的嵌入式应用专门设计的ARM Cortex-M内核，其中队里使用的STM32F407， 时钟频率达到168MHz，内置高速存储器。

STM32F407xx系列供电电压2.0V至3.6V，外设有：

3个12-bit ADC；

2个DAC；

1个低功耗RTC；

12个通用16位定时器，其中包括两个用于电机控制的PWM定时器，两个通用32位定时器；

一个真正的随机数发生器（RNG）

3个 I2C模块

3个SPI；

2个全双工 I2S（为了实现音频级的精确度，I2S外设的时钟频率可以通过一个专门的内部音频PLL或通过外部时钟，以允许同步）；

4个USART +2个的UART；

USB OTG；

2个CAN模块；

一个SDIO/ MMC接口

网络接口；

相机接口。

各常用模块介绍如下：

### 1)  总线

STM32核心通过特殊的指令总线与Flash存储器连接，数据总线与系统总线又与先进高速(AHB)相连，内部SPRAM和DMA单元直接与AHB总线相连，外部设备通过两条先进设备总线(APB)连接，AHB总线的工作频率内核一致，APB2总线的工作频率最大可达72MHz，APB1总线频率为36MHz。

2020补充：以上为STM32F103的芯片参数，STM32F407主频可达168MHZ。

### 2)  通用输入输出接口(GPIO)

STM32可提供80个GPIO，分布在A—E 5个端口上，每个端口有16个GPIO，每个GPIO管脚都可以由软件配置成输出(推拉或开路)、输入(带或不带上拉或下拉)或其它的外设功能；多数GPIO管脚都与数字或模拟的外设功能管脚共用。

2020补充：一般来说，输出都选择上拉推挽输出。输入就要看选择了；如果是要检测高电平的话，就要选择下拉，如果是检测低电平就要上拉。

### 3)  中断控制器(NVIC) 和外部中断/事件控制器(EXTI)

NVIC可处理多达43个可屏蔽中断通道和16个优先级，中断返回时自动恢复，无需额外指令，该类中断包括串口中断、定时\计数器中断等。EXTI包含19个边沿检测器，用于产生中断/事件请求，多达80个通用I/O口连接到16个外部中断线，每个中断线都可以独立地配置它的触发事件(上升沿或下降沿或双边沿)。

配置过程：

1）将I/O口设置为输入模式，根据中断方式选择上拉下拉；

2）开启SYSCFG时钟，设置IO口与中断线的对应关系；

3）初始化，配置中断触发方式和对应的线路；

4）配置中断通道和优先级等，使能中断。

中断程序中最好加入消抖动，即10ms左右延时

### 4) 通用同步/异步接受发送器(USART)

其中一个USART接口通信速率可达4.5兆位/秒，其他USART接口通信速率可达2.25兆位/秒。

配置过程：

1）串口时钟和GPIO时钟使能；

2）设置引脚复用器映射（哪个管脚映射为什么功能接口）；

3）GPIO端口模式设置，把工作模式设为 复用；

4）串口参数初始化：设置波特率，字长，奇偶校验等参数；

5）使能串口，即USART_Cmd函数enable，配置完成。

通过检测特定标志位来确认发送接收的情况。

2020补充：串口能做到1发多，但是无法1收多，而且能发送的数量也不好说，保底为2。

### 5)  通用定时器(TIMx)

STM32F103有3个同步的标准定时器(TIM2、TIM3、TIM4，TIM1为高级定时器)，每个定时器都有一个16位的自动加载递加/递减计数器、一个16位的预分频器和4个独立的通道，每个通道都可用于输入捕获、输出比较、 PWM和单脉冲模式输出。

对于STM32F407，STM32F4 的定时器功能十分强大，有 TIME1 和 TIME8 等高级定时器，也有 TIME2~TIME5，TIM9~TIM14 等通用定时器，还有 TIME6 和 TIME7 等基本定时器，总共达 14 个定时器之多。

定时器使用目前有两种情况：定时器计时中断，PWM波发生。

定时中断配置过程：

1）定时器时钟使能；

2）初始化定时器参数, 设置自动重装值，分频系数，计数方式等；

3）设置允许更新中断，然后设置中断优先级等；

4）使能定时器。

PWM发生配置过程：

1）开启定时器和I/O口时钟，配置I/O选择复用功能输出；

2）初始化定时器参数, 设置自动重装值，分频系数，计数方式等；

3）设置定时器的 PWM模式，使能定时器的指点通道输出

4）使能定时器

5）调节占空比

### 6)  串行外设接口(SPI)

2个SPI接口，在从或主模式下，全双工和半双工的通信速率可达18兆位/秒。 3位的预分频器可产生8种主模式频率，可配置成每帧8位或16位。

2020补充：现在基本都在使用软件SPI接口，自己控制时序。

### 7)  ADC(模拟/数字转换器)

STM32F103有2个12位的模拟/数字转换器(ADC)，每个ADC有多达16个外部通道，可以执行单次或扫描转换模式；在扫描模式下，转换在一组选定的模拟输入上自动进行。

### 8)  控制器区域网络(CAN)

CAN接口兼容规范2.0A和2.0B (主动)，位速率达1兆位/秒。它可以接收和发送11位标识符的标准帧，也接收和发送29位标识符的扩展帧。具有2个接收FIFOs， 3级14个可调节的滤波器。内部SRAM缓冲最多可处理32个报文对象。

补充：

CAN基础知识介绍

CAN是Controller Area
Network(控制器局域网络)的缩写，是ISO国际标准化组织的串行通信协议。CAN主要用在两个设备之间的通讯。

CAN的特点

多主控制。总线空闲时，所有单元都可发送消息，而两个以上的单元同时发送消息时，根据标识符(ID, 非地址)决定优先级。两个以上的单元同时开始发送消息时，对各消息ID的每个位进行逐个仲裁比较。仲裁获胜(优先级最高)的单元可继续发送消息，仲裁失利的单元则立即停止发送而进行接收工作。

系统柔软性。连接总线的单元，没有类似"地址"的信息。因此，在总线上添加单元时，以连接的其他单元的软硬件和应用层都不需要做改变。

速度快，距离远。最高1Mbps(距离<40m)，最远可达10KM(速率<5Kbps)。CAN物理层的形式主要分为闭环总线和开环总线，一个适合于高速通讯，一个适合于远距离通讯(速度慢)。闭环通讯网络是一种高速、短距离网络，它的总线最大长度为40m，通信速度最高1Mbps，总线的两端各要求有一个"120欧"的电阻。开环总线网络是低速、远距离网络，它的最大传输距离1km，最高通讯速率为125kbps，两根总线是独立的、不形成闭环，要求每根总线上各串联有一个"2.2千欧"的电阻。

具有错误检测/错误通知和错误恢复功能。所有单元都可以检测错误(错误检测功能)，检测出错误的单元会立即同时通知其他所有单元(错误通知功能)，正在发送消息的单元一旦检测出错误，会强制结束当前的发送。强制结束发送的单元会不断反复地重新发送次消息直到成功发送位置(错误恢复功能)。

故障封闭功能。CAN可以判断出错误的类型是总线上数据错误(如外部噪声等)还是持续的数据错误(如单元内部故障、驱动器故障、断线等)。由此功能，当总线上发生次序数据错误时，可将引起此故障的单元从总线上隔离出去。

连接节点多。CAN总线可同时可同时连接多个单元。可连接的单元总数理论上是没有限制的。但实际上可连接的单元受总线上的时间延迟及电气负载的限制。降低通信速度，可连接的单元数增加；提高通信速度，则可连接的单元数减少。

物理层特征

与I2C/SPI等具有始终信号的同步通讯方式不同，CAN通讯并不是以时钟信号来进行同步的，它是一种异步通信，只具有CAN_High和CAN_Low两条信号线，共同构成一组差分信号线，以差分信号的形式进行通讯。

CAN控制器根据CAN_L和CAN_H 上的电位差来判断总线电平。总线电平分为显性电平和隐形电平，二者比居其一。发送方通过使总线电平发生变化，将消息发送给接收方。

显性电平对应逻辑：0

CAN_High的电平为3.5V，CAN_Low线的电平为1.5V，CAN_H和CAN_L的电压差为2V左右。

隐性电平对应逻辑：1

CAN_High和CAN_Low线上的电压均为2.5v, CAN_H和CAN_L之间的电压差为0V。

显性电平具有优先权，只要有一个单元输出显性电平，总线上即为显性电平。而隐形电平则具有包容的意味，只要所有的单元都输出隐形电平，总线上才为隐形电平(显性电平比隐形电平更强)。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-55-22-image.png)

通讯节点

CAN总线上可以挂载多个通讯节点，节点之间的信号经过总线传输，实现节点间通讯。由于CAN通讯协议不对节点进行地址编码，而是对数据内容进行编码，所以网络中的节点个数理论上不 受限制，只要总线的负载足够即可，可以通过中继器增强负载。

CAN通讯节点由一个CAN控制器及CAN收发器组成，控制器与收发器(电平转换)之间通过CAN_Tx及CAN_Rx信号线相连，收发器与CAN总线之间使用CAN_High及CAN_Low信号线相连。

当CAN节点需要发送数据时，控制器把要发送的二进制编码通过CAN_Tx线发送到收发器，然后有收发器把这个普通的逻辑电平转化为差分信号，通过差分线CAN_High和CAN_Low线输出到CAN总线网络。而通过收发器接收总线上的数据到控制器时，则是相反的过程，收发器把总线上收到的CAN_High及CAN_Low信号转化为普通的逻辑电平信号，通过CAN_Rx输出到控制器中。

由于CAN总线协议的物理层只有1对差分线，在一个时刻只能表示一个信号，所以对通讯节点来说，CAN通讯是半双工的，收发数据需要分时进行。在CAN的通讯网络中，因为共用总线，在整个网络中同一时刻只能有一个通讯节点发送信号，其余的节点在该时刻都只能接收。

波特率及位同步

由于CAN属于异步通讯，没有时钟信号线，连接在同一个总线网络中的各个节点会像串口通讯那样，节点间使用约定好的波特率进行通讯，特别地，CAN还会使用"位同步"的方式来抗干扰/吸收误差，实现对总线电平信号进行正确的采样，确保通讯正常。

位时序分解

为了实现位同步，CAN协议把每一个数据位的时序分解成SS段，PTS段，PBS1段，PBS2段，这四段的长度加起来即为一个CAN数据位的长度。分解后最小的时间单位是Tq，而一个完整的位由8~25个Tq组成。

SS(SYNC SEG)段

SS段译为同步段，若通讯节点检测到总线上信号的跳变被包含在SS段的范围之内，则表示节点与总线的时序是同步的，当节点与总线同步时，采样点采集到的总线电平即可被确定为该位的电平。SS段固定大小为1Tq。

PTS段(PROP SEG)

PTS段译为传播时间段，这个时间段是用于补偿网络的物理延时时间。是总线上输入比较器延时和输出驱动器延时总和的两倍。PTS段的大小可以为1~8Tq。

PBS1段(PHASE SEG1)

PBS1译为相位缓冲段，主要用来补偿边沿阶段的误差，它的时间长度在重新同步的时候可以加长。PBS1段的初始大小可以为1~8Tq。

PBS2段(PHASE SEG2)

PBS2是另一个相位缓冲段，也是用来补偿边沿阶段误差的，它的时间长度在重新同步时可以缩短。PBS2段的初始大小可以为2~8Tq。

       信号的采样点位于PBS1段与PBS2段之间，通过控制各段的长度，可以对采样点的位置进行偏移，以便准确地采样。

帧种类介绍

        CAN通信以5种类型的帧进行： 数据帧：用于通讯节点向外传送数据。 遥控帧：用于向远端节点请求数据。 错误帧：用于向远端节点通知校验错误，请求重新发送上一个数据。 过载帧：用于通知远端节点：本节点尚未做好接受准备。 间隔帧：用于将数据帧

数据帧介绍

帧开始

       表示数据帧开始的段，`SOT`段(`Start Of Frame`)，帧起始信号只有一个数据位，是一个**显性电平**(逻辑0)，它用于通知各个节点将有数据传输，其他节点通过帧起始信号的电平跳变沿来进行硬同步。

仲裁段

       表示该帧优先级的段，当同时有两个报文被发送时，总线会根据仲裁段的内容决定哪个数据包能被传输。仲裁段的内容主要为本数据帧的ID信息(标识符)，数据帧具有标准格式和扩展格式两种，区别在于ID信息的长度，标准格式的ID为11位，扩展格式的ID格式为29位，它在标准ID的基础上多出18位。 在CAN协议中，ID决定着数据帧发送的优先级，也决定着其他节点是否会接收这个数据帧。CAN协议不对挂载在它之上的节点分配优先级和地址，对总线的占有权是由信息的重要性决定的，即对于重要的信息，可给它打包上一个优先级高的ID，使它能够及时地发送出去。 报文的优先级(越小越高)，是通过对ID的仲裁来确定的。根据前面的物理层的分析，如果总线上同时出现显性电平和隐形电平，总线的状态会被置为显性电平，CAN正是利用这个特性进行仲裁。 仲裁段ID的优先级也影响着接收设备对报文的反应。因为在CAN总线上数据是以**广播**的形式发送的，所有连接到CAN总线的节点都会收到所有其他节点发出的有效数据，因而CAN控制器大多具有根据ID过滤报文的功能，它可以控制自己只接收某些ID的报文。

控制段

       表示数据的字节数及保留位的段

数据段

       数据的内容，一帧可发送0~8个字节的数据，MSB先行

CRC段

       检查帧的传输错误的段，CAN的报文包含一段15位的CRC校验码，一旦接收节点算出的CRC码跟接收到的CRC码不同，则它会向发送节点反馈错误信息，利用错误帧请求它重新发送。CRC部分的计算一般有CAN控制器硬件完成，出错时的处理则由软件控制最大重发数。 在CRC校验码之后，有一个CRC界定符，它为隐形位，主要作用是把CRC校验码与后面的ACK段间隔起来。

ACK段

       表示确认正常接收的段。ACK段包括一个ACK槽位，和ACK界定符位。在ACK槽位中，发送节点发送的是隐性位，而接收节点则在这一位中发送显性位以示应答。在ACK和帧结束之间由ACK界定符间隔开。 7. 帧结束 表示数据帧结束的段。帧结束段由发送节点发送的7个隐形位表示结束。及遥控帧与前面的帧分离开来的帧。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-55-42-image.png)

STM32F4对于CAN通信的设置

其中：CAN_Prescaler，CAN_SJW，CAN_BS1 和 CAN_BS2 分别用来设置波特率分频器

波特率计算公式为，Braudrate = 42M/(( CAN_SJW + CAN_BS1+ CAN_BS2)* CAN_Prescaler)。一般来说，我们在机器人上使用时，都会设置成1M，发送一位数据只需要1us。一般来说，一个标准数据帧的长度不会超过150位，所以数据传输速度还是可以的。

其他设置CAN工作模式的参数，基本照猫画虎即可，主要是功能有点复杂……

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-55-52-image.png)

然后是设置滤波器

CAN1滤波器组是从0到13

CAN2滤波器组是从14到28

滤波器筛选的是CAN_ID，而CAN_ID又是分为标准和扩展两类

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-55-58-image.png)

如上图，基本格式不存在扩展ID，而扩展格式中ID0~ID17为Extension ID,而ID18~ID28为Base ID。

因此CAN ID值0x1800f001用二进制表示为：0b 0001 1000 0000 0000 1111 0000 0000 0001,用括号分别区别为：0b 000[1 1000 0000 00][00 1111 0000 0000 0001]，红色部分为扩展ID，蓝色部分为基本ID。

我们设置滤波器时有两个要注意的点：ID和MASKID，ID就是筛选要接受的信息的CAN_ID，MASKID决定了哪些位进行筛选，如果MASKID均为0，意思是对32位ID所有的位都不进行筛选。

![](C:\Users\ziche\AppData\Roaming\marktext\images\2023-07-13-17-56-05-image.png)

模式一般选择屏蔽位模式，即：CAN_FilterMode_IdMask。

别的就没什么了。

## 编程方法
